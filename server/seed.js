import { readFileSync } from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { getDb, initSchema } from './db.js';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const dataPath = path.join(__dirname, '..', 'data', 'counties.json');

const PROVINCE_MAP = {
  昆山: '江苏省', 江阴: '江苏省', 张家港: '江苏省', 常熟: '江苏省', 太仓: '江苏省', 丹阳: '江苏省',
  海安: '江苏省', 如皋: '江苏省', 启东: '江苏省', 靖江: '江苏省', 泰兴: '江苏省', 兴化: '江苏省',
  溧阳: '江苏省', 扬中: '江苏省', 东台: '江苏省', 邳州: '江苏省', 新沂: '江苏省', 沛县: '江苏省',
  沭阳: '江苏省', 如东: '江苏省', 海门: '江苏省', 义乌: '浙江省', 慈溪: '浙江省', 诸暨: '浙江省',
  乐清: '浙江省', 温岭: '浙江省', 瑞安: '浙江省', 余姚: '浙江省', 海宁: '浙江省', 桐乡: '浙江省',
  平湖: '浙江省', 嘉善: '浙江省', 海盐: '浙江省', 长兴: '浙江省', 德清: '浙江省', 安吉: '浙江省',
  宁海: '浙江省', 象山: '浙江省', 玉环: '浙江省', 临海: '浙江省', 永康: '浙江省', 东阳: '浙江省',
  兰溪: '浙江省', 嵊州: '浙江省', 新昌: '浙江省', 平阳: '浙江省', 苍南: '浙江省', 永嘉: '浙江省',
  晋江: '福建省', 福清: '福建省', 南安: '福建省', 石狮: '福建省', 惠安: '福建省', 安溪: '福建省',
  龙海: '福建省', 漳浦: '福建省', 仙游: '福建省', 福鼎: '福建省', 福安: '福建省', 永春: '福建省',
  德化: '福建省', 龙口: '山东省', 胶州: '山东省', 即墨: '山东省', 平度: '山东省', 莱西: '山东省',
  滕州: '山东省', 莱州: '山东省', 莱阳: '山东省', 招远: '山东省', 栖霞: '山东省', 海阳: '山东省',
  青州: '山东省', 诸城: '山东省', 寿光: '山东省', 安丘: '山东省', 高密: '山东省', 昌邑: '山东省',
  曲阜: '山东省', 邹城: '山东省', 新泰: '山东省', 肥城: '山东省', 荣成: '山东省', 乳山: '山东省',
  文登: '山东省', 桓台: '山东省', 广饶: '山东省', 垦利: '山东省', 邹平: '山东省', 博兴: '山东省',
  沂水: '山东省', 兰陵: '山东省', 郯城: '山东省', 临沭: '山东省', 神木: '陕西省', 长沙: '湖南省',
  浏阳: '湖南省', 宁乡: '湖南省', 醴陵: '湖南省', 攸县: '湖南省', 茶陵: '湖南省', 炎陵: '湖南省',
  湘乡: '湖南省', 韶山: '湖南省', 湘潭: '湖南省', 衡阳: '湖南省', 衡南: '湖南省', 衡山: '湖南省',
  衡东: '湖南省', 祁东: '湖南省', 新郑: '河南省', 巩义: '河南省', 荥阳: '河南省', 新密: '河南省',
  登封: '河南省', 中牟: '河南省', 禹州: '河南省', 长葛: '河南省', 永城: '河南省', 长垣: '河南省',
  林州: '河南省', 安阳: '河南省', 滑县: '河南省', 浚县: '河南省', 淇县: '河南省', 辉县: '河南省',
  卫辉: '河南省', 孟州: '河南省', 沁阳: '河南省', 温县: '河南省', 武陟: '河南省', 博爱: '河南省',
  肥西: '安徽省', 肥东: '安徽省', 长丰: '安徽省', 庐江: '安徽省', 巢湖: '安徽省', 无为: '安徽省',
  芜湖: '安徽省', 繁昌: '安徽省', 南陵: '安徽省', 怀宁: '安徽省', 桐城: '安徽省', 潜山: '安徽省',
  太湖: '安徽省', 宿松: '安徽省', 望江: '安徽省', 岳西: '安徽省', 怀远: '安徽省', 五河: '安徽省',
  固镇: '安徽省', 凤阳: '安徽省', 天长: '安徽省', 明光: '安徽省', 定远: '安徽省', 全椒: '安徽省',
  来安: '安徽省', 凤台: '安徽省', 寿县: '安徽省', 霍邱: '安徽省', 舒城: '安徽省', 金寨: '安徽省',
  霍山: '安徽省', 郎溪: '安徽省', 广德: '安徽省', 泾县: '安徽省', 绩溪: '安徽省', 旌德: '安徽省',
  宁国: '安徽省', 当涂: '安徽省', 含山: '安徽省', 和县: '安徽省', 濉溪: '安徽省', 枞阳: '安徽省',
  东至: '安徽省', 石台: '安徽省', 青阳: '安徽省', 仙桃: '湖北省', 潜江: '湖北省', 天门: '湖北省',
  大冶: '湖北省', 宜都: '湖北省', 枝江: '湖北省', 当阳: '湖北省', 枣阳: '湖北省', 宜城: '湖北省',
  老河口: '湖北省', 谷城: '湖北省', 南漳: '湖北省', 保康: '湖北省', 京山: '湖北省', 钟祥: '湖北省',
  沙洋: '湖北省', 监利: '湖北省', 洪湖: '湖北省', 松滋: '湖北省', 石首: '湖北省', 公安: '湖北省',
  江陵: '湖北省', 增城: '广东省', 从化: '广东省', 南沙: '广东省', 博罗: '广东省', 惠东: '广东省',
  龙门: '广东省', 台山: '广东省', 开平: '广东省', 鹤山: '广东省', 恩平: '广东省', 普宁: '广东省',
  高州: '广东省', 化州: '广东省', 信宜: '广东省', 电白: '广东省', 四会: '广东省', 广宁: '广东省',
  德庆: '广东省', 封开: '广东省', 怀集: '广东省', 佛冈: '广东省', 阳山: '广东省', 连南: '广东省',
  连山: '广东省', 清新: '广东省', 英德: '广东省', 连州: '广东省', 新兴: '广东省', 郁南: '广东省',
  云安: '广东省', 罗定: '广东省', 阳春: '广东省', 阳东: '广东省', 阳西: '广东省', 遂溪: '广东省',
  徐闻: '广东省', 雷州: '广东省', 廉江: '广东省', 吴川: '广东省', 高要: '广东省', 鼎湖: '广东省',
  三水: '广东省', 高明: '广东省', 新会: '广东省', 斗门: '广东省', 金湾: '广东省', 揭东: '广东省',
  揭西: '广东省', 惠来: '广东省',
};

function getProvince(name) {
  const key = name.replace(/[市县区]$/, '');
  return PROVINCE_MAP[key] || '';
}

// 各城市近似经纬度 [lat, lng]，用于地图展示
const COORDS_MAP = {
  昆山: [31.38, 120.98], 江阴: [31.92, 120.28], 张家港: [31.87, 120.55], 常熟: [31.65, 120.75],
  义乌: [29.32, 120.08], 晋江: [24.78, 118.55], 慈溪: [30.17, 121.25], 宜兴: [31.34, 119.82],
  神木: [38.83, 110.50], 诸暨: [29.72, 120.23], 长沙: [28.23, 112.94], 龙口: [37.65, 120.48],
  太仓: [31.45, 121.13], 乐清: [28.11, 120.97], 温岭: [28.37, 121.37], 瑞安: [27.78, 120.66],
  余姚: [30.03, 121.15], 福清: [25.72, 119.38], 丹阳: [32.00, 119.60], 海宁: [30.53, 120.68],
  桐乡: [30.63, 120.57], 海安: [32.53, 120.45], 如皋: [32.37, 120.57], 启东: [31.82, 121.65],
  靖江: [31.98, 120.27], 泰兴: [32.17, 120.05], 兴化: [32.93, 119.85], 溧阳: [31.42, 119.48],
  扬中: [32.23, 119.82], 东台: [32.87, 120.32], 邳州: [34.35, 118.00], 新沂: [34.37, 118.35],
  沛县: [34.73, 116.93], 沭阳: [34.13, 118.80], 如东: [32.33, 121.18], 海门: [31.87, 121.18],
  平湖: [30.70, 121.02], 嘉善: [30.85, 120.92], 海盐: [30.53, 120.95], 长兴: [31.03, 119.90],
  德清: [30.53, 119.97], 安吉: [30.63, 119.68], 宁海: [29.30, 121.43], 象山: [29.48, 121.87],
  玉环: [28.13, 121.23], 临海: [28.85, 121.15], 永康: [28.90, 120.02], 东阳: [29.27, 120.23],
  兰溪: [29.22, 119.48], 嵊州: [29.60, 120.82], 新昌: [29.50, 120.90], 平阳: [27.67, 120.57],
  苍南: [27.52, 120.43], 永嘉: [28.15, 120.68], 南安: [24.97, 118.38], 石狮: [24.73, 118.65],
  惠安: [25.03, 118.80], 安溪: [25.07, 118.18], 龙海: [24.45, 117.82], 漳浦: [24.12, 117.62],
  仙游: [25.37, 118.70], 福鼎: [27.33, 120.22], 福安: [27.10, 119.65], 永春: [25.32, 118.30],
  德化: [25.50, 118.25], 胶州: [36.27, 120.03], 即墨: [36.39, 120.45], 平度: [36.77, 119.96],
  莱西: [36.89, 120.53], 滕州: [35.12, 117.17], 莱州: [37.18, 119.95], 莱阳: [36.98, 120.72],
  招远: [37.36, 120.43], 栖霞: [37.34, 120.85], 海阳: [36.78, 121.18], 青州: [36.70, 118.48],
  诸城: [35.98, 119.42], 寿光: [36.87, 118.73], 安丘: [36.48, 119.22], 高密: [36.38, 119.76],
  昌邑: [36.87, 119.40], 曲阜: [35.58, 116.98], 邹城: [35.40, 117.00], 新泰: [35.92, 117.77],
  肥城: [36.18, 116.77], 荣成: [37.17, 122.49], 乳山: [36.92, 121.54], 文登: [37.20, 122.05],
  桓台: [36.97, 118.10], 广饶: [37.05, 118.42], 垦利: [37.57, 118.55], 邹平: [36.88, 117.73],
  博兴: [37.15, 118.13], 沂水: [35.78, 118.63], 兰陵: [34.72, 118.07], 郯城: [34.62, 118.35],
  临沭: [34.92, 118.65], 新郑: [34.40, 113.74], 巩义: [34.75, 113.02], 荥阳: [34.79, 113.38],
  新密: [34.54, 113.39], 登封: [34.46, 113.05], 中牟: [34.72, 113.98], 禹州: [34.16, 113.49],
  长葛: [34.22, 113.77], 永城: [33.95, 116.45], 长垣: [35.20, 114.67], 林州: [36.08, 113.82],
  安阳: [36.10, 114.35], 滑县: [35.58, 114.52], 浚县: [35.68, 114.55], 淇县: [35.60, 114.20],
  辉县: [35.46, 113.80], 卫辉: [35.40, 114.07], 孟州: [34.92, 112.80], 沁阳: [35.08, 112.93],
  温县: [34.94, 113.08], 武陟: [35.10, 113.40], 博爱: [35.17, 113.07], 肥西: [31.72, 117.17],
  肥东: [31.89, 117.47], 长丰: [32.48, 117.17], 庐江: [31.26, 117.29], 巢湖: [31.60, 117.87],
  无为: [31.30, 117.98], 芜湖: [31.35, 118.38], 繁昌: [31.10, 118.20], 南陵: [30.92, 118.33],
  怀宁: [30.73, 116.83], 桐城: [31.05, 116.95], 潜山: [30.63, 116.58], 太湖: [30.45, 116.25],
  宿松: [30.15, 116.13], 望江: [30.12, 116.69], 岳西: [30.85, 116.35], 怀远: [32.97, 117.20],
  五河: [33.15, 117.88], 固镇: [33.32, 117.32], 凤阳: [32.87, 117.53], 天长: [32.68, 119.00],
  明光: [32.78, 117.98], 定远: [32.53, 117.68], 全椒: [32.10, 118.27], 来安: [32.45, 118.43],
  凤台: [32.70, 116.72], 寿县: [32.55, 116.78], 霍邱: [32.35, 116.28], 舒城: [31.47, 116.95],
  金寨: [31.73, 115.93], 霍山: [31.40, 116.33], 郎溪: [31.13, 119.18], 广德: [30.90, 119.42],
  泾县: [30.68, 118.42], 绩溪: [30.07, 118.58], 旌德: [30.28, 118.53], 宁国: [30.63, 118.98],
  当涂: [31.57, 118.50], 含山: [31.42, 118.10], 和县: [31.75, 118.35], 濉溪: [33.92, 116.77],
  枞阳: [30.70, 117.22], 东至: [30.10, 117.03], 石台: [30.22, 117.48], 青阳: [30.65, 117.85],
  仙桃: [30.37, 113.45], 潜江: [30.42, 112.90], 天门: [30.66, 113.17], 大冶: [30.10, 114.98],
  宜都: [30.38, 111.45], 枝江: [30.43, 111.77], 当阳: [30.82, 111.78], 枣阳: [32.13, 112.77],
  宜城: [31.72, 112.25], 老河口: [32.38, 111.68], 谷城: [32.27, 111.65], 南漳: [31.78, 111.83],
  保康: [31.88, 111.27], 京山: [31.02, 113.12], 钟祥: [31.17, 112.58], 沙洋: [30.72, 112.58],
  监利: [29.83, 112.90], 洪湖: [29.83, 113.48], 松滋: [30.18, 111.77], 石首: [29.72, 112.42],
  公安: [30.07, 112.23], 江陵: [30.05, 112.42], 浏阳: [28.15, 113.64], 宁乡: [28.28, 112.55],
  醴陵: [27.65, 113.50], 攸县: [27.00, 113.35], 茶陵: [26.78, 113.54], 炎陵: [26.49, 113.78],
  湘乡: [27.73, 112.53], 韶山: [27.92, 112.53], 湘潭: [27.83, 112.93], 衡阳: [26.90, 112.60],
  衡南: [26.75, 112.68], 衡山: [27.23, 112.87], 衡东: [27.08, 112.95], 祁东: [26.80, 112.12],
};
const DEFAULT_COORDS = [35.0, 105.0]; // 中国中心近似

function getCoords(name) {
  const key = name.replace(/[市县区]$/, '');
  return COORDS_MAP[key] || DEFAULT_COORDS;
}

function foodImageUrl(foodName) {
  return 'https://placehold.co/400x300/e8f5e9/1b5e20?text=' + encodeURIComponent(foodName);
}
function hotelImageUrl(hotelName) {
  return 'https://placehold.co/400x300/e3f2fd/1565c0?text=' + encodeURIComponent(hotelName);
}

let crawledImages = {};
try {
  const crawledPath = path.join(__dirname, '..', 'data', 'crawled-images.json');
  crawledImages = JSON.parse(readFileSync(crawledPath, 'utf8'));
} catch (_) {}

initSchema();
const db = getDb();
const data = JSON.parse(readFileSync(dataPath, 'utf8'));

const insert = db.prepare(
  `INSERT INTO counties (name, food, hotel, price, food_image, food_name_en, hotel_image, hotel_name_en, province, gdp_rank, lat, lng)
   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
);

db.exec('DELETE FROM counties');
const run = db.transaction(() => {
  data.forEach((row, i) => {
    const province = row.province ?? getProvince(row.name);
    const [lat, lng] = row.lat != null && row.lng != null ? [row.lat, row.lng] : getCoords(row.name);
    const crawled = crawledImages[row.name];
    const foodImg = row.food_image || (crawled?.food_image) || foodImageUrl(row.food);
    const hotelImg = row.hotel_image || (crawled?.hotel_image) || hotelImageUrl(row.hotel);
    insert.run(
      row.name,
      row.food,
      row.hotel,
      row.price,
      foodImg,
      row.food_name_en ?? '',
      hotelImg,
      row.hotel_name_en ?? '',
      province,
      row.gdp_rank ?? i + 1,
      lat,
      lng
    );
  });
});
run();

console.log('Seeded', data.length, 'counties into data/counties.db');
